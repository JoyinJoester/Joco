use eframe::{egui, CreationContext};
use egui::{Align, Color32, Layout, Slider, FontData, FontFamily};
use gilrs::{Gilrs};
use log::{info, error, warn};
use std::sync::{Arc, Mutex};
use std::time::{Instant, Duration};

use crate::embedded_font;
use crate::config::Config;
use crate::gamepad_controller::GamepadController;

/// è·å–æŒ‰é’®æ˜¾ç¤ºåç§°
fn button_display_name(button_name: &str) -> &str {
    match button_name {
        "South" => "A/å—æŒ‰é’®",
        "East" => "B/ä¸œæŒ‰é’®",
        "North" => "Y/åŒ—æŒ‰é’®",
        "West" => "X/è¥¿æŒ‰é’®",
        "LeftTrigger" => "å·¦æ‰³æœº",
        "RightTrigger" => "å³æ‰³æœº",
        "LeftThumb" => "å·¦æ‘‡æ†æŒ‰ä¸‹",
        "RightThumb" => "å³æ‘‡æ†æŒ‰ä¸‹",
        "Start" => "å¼€å§‹æŒ‰é’®",
        "Select" => "é€‰æ‹©æŒ‰é’®",
        "Mode" => "æ¨¡å¼æŒ‰é’®",
        "DPadUp" => "åå­—é”®ä¸Š",
        "DPadDown" => "åå­—é”®ä¸‹",
        "DPadLeft" => "åå­—é”®å·¦",
        "DPadRight" => "åå­—é”®å³",
        _ => "æœªçŸ¥æŒ‰é’®",
    }
}

/// è·å–æŒ‰é’®é€‰é¡¹åˆ—è¡¨
fn get_button_options() -> Vec<(String, &'static str)> {
    vec![
        ("South".to_string(), "A/å—æŒ‰é’®"),
        ("East".to_string(), "B/ä¸œæŒ‰é’®"),
        ("North".to_string(), "Y/åŒ—æŒ‰é’®"),
        ("West".to_string(), "X/è¥¿æŒ‰é’®"),
        ("LeftTrigger".to_string(), "å·¦æ‰³æœº"),
        ("RightTrigger".to_string(), "å³æ‰³æœº"),
        ("LeftThumb".to_string(), "å·¦æ‘‡æ†æŒ‰ä¸‹"),
        ("RightThumb".to_string(), "å³æ‘‡æ†æŒ‰ä¸‹")
    ]
}

/// GUIåº”ç”¨ç¨‹åºçŠ¶æ€
pub struct GamepadMouseApp {
    config: Config,
    controller: Option<Arc<Mutex<GamepadController>>>,
    active: bool,
    gamepad_name: String,
    status_message: String,
    status_color: Color32,
    show_help: bool,
    tray_tooltip: String,
    // å¯ç”¨çš„æ‰‹æŸ„åˆ—è¡¨
    available_gamepads: Vec<(gilrs::GamepadId, String)>,
    selected_gamepad_index: usize,
    // æ‰«æè®¡æ—¶å™¨ï¼Œç”¨äºå®šæœŸæ£€æŸ¥æ‰‹æŸ„è¿æ¥çŠ¶æ€
    last_scan_time: Instant,
    // æ‰‹æŸ„é€‰æ‹©æ›´æ–°æ ‡å¿—
    selected_gamepad_changed: Option<usize>,
    // æœ€åä¸€æ¬¡è¿æ¥å°è¯•æ—¶é—´ï¼Œé˜²æ­¢é¢‘ç¹é‡è¯•
    last_connection_attempt: Instant,
    // è¿æ¥é‡è¯•è®¡æ•°å™¨
    connection_retry_count: usize,
    // ä¸Šæ¬¡é”™è¯¯æ¶ˆæ¯ï¼Œé¿å…é‡å¤è®°å½•ç›¸åŒé”™è¯¯
    last_error_message: Option<String>,
}

impl GamepadMouseApp {
    /// åˆ›å»ºæ–°çš„åº”ç”¨ç¨‹åºå®ä¾‹
    pub fn new(cc: &CreationContext) -> Self {
        // åŠ è½½é…ç½®
        let config = Config::load();
        
        // è®¾ç½®è‡ªå®šä¹‰å­—ä½“
        setup_custom_fonts(&cc.egui_ctx);
        
        Self {
            config,
            controller: None,
            active: false,
            gamepad_name: "æ— æ‰‹æŸ„è¿æ¥".to_string(),
            status_message: "æœªå¯åŠ¨".to_string(),
            status_color: Color32::GRAY,
            show_help: false,
            tray_tooltip: "æ¸¸æˆæ‰‹æŸ„é¼ æ ‡æ§åˆ¶å™¨ - æœªå¯åŠ¨".to_string(),
            available_gamepads: Vec::new(),
            selected_gamepad_index: 0,
            last_scan_time: Instant::now(),
            selected_gamepad_changed: None,
            last_connection_attempt: Instant::now().checked_sub(Duration::from_secs(10)).unwrap_or(Instant::now()),
            connection_retry_count: 0,
            last_error_message: None,
        }
    }

    /// å¯åŠ¨æ‰‹æŸ„æ§åˆ¶å™¨
    pub fn start_controller(&mut self) {
        info!("å°è¯•å¯åŠ¨æ§åˆ¶å™¨");
        self.connection_retry_count += 1;
        
        // å°è¯•åˆå§‹åŒ–Gilrs
        match Gilrs::new() {
            Ok(gilrs) => {
                // æ£€æŸ¥æ˜¯å¦æœ‰æ‰‹æŸ„è¿æ¥
                let mut found_gamepad = false;
                
                for (id, gamepad) in gilrs.gamepads() {
                    let name = gamepad.name().to_string();
                    info!("å‘ç°æ‰‹æŸ„: {} å·²è¿æ¥", name);
                    
                    // åˆ›å»ºæ§åˆ¶å™¨å®ä¾‹
                    let controller = GamepadController::new(
                        gilrs,
                        id,
                        self.config.clone(),
                    );
                    
                    // ä¿å­˜æ§åˆ¶å™¨å¼•ç”¨
                    self.controller = Some(Arc::new(Mutex::new(controller)));
                    self.gamepad_name = name;
                    self.status_message = "å·²è¿æ¥ï¼Œæ§åˆ¶å™¨è¿è¡Œä¸­".to_string();
                    self.status_color = Color32::GREEN;
                    self.active = true;
                    self.tray_tooltip = format!("æ¸¸æˆæ‰‹æŸ„é¼ æ ‡æ§åˆ¶å™¨ - {}", self.gamepad_name);
                    self.connection_retry_count = 0; // é‡ç½®é‡è¯•è®¡æ•°
                    found_gamepad = true;
                    break;
                }
                
                if !found_gamepad {
                    self.status_message = "æœªæ‰¾åˆ°è¿æ¥çš„æ‰‹æŸ„".to_string();
                    self.status_color = Color32::RED;
                    self.active = false;
                    warn!("æœªæ‰¾åˆ°è¿æ¥çš„æ‰‹æŸ„");
                }
            },
            Err(err) => {
                let error_message = format!("æ— æ³•åˆå§‹åŒ–æ‰‹æŸ„: {}", err);
                
                // åªæœ‰å½“é”™è¯¯æ¶ˆæ¯ä¸åŒæ—¶æ‰è®°å½•
                if self.last_error_message.as_ref() != Some(&error_message) {
                    error!("{}", error_message);
                    self.last_error_message = Some(error_message.clone());
                }
                
                self.status_message = error_message;
                self.status_color = Color32::RED;
                self.active = false;
            }
        }
        
        // æ›´æ–°æœ€åè¿æ¥å°è¯•æ—¶é—´
        self.last_connection_attempt = Instant::now();
    }
    
    /// åœæ­¢æ‰‹æŸ„æ§åˆ¶å™¨
    pub fn stop_controller(&mut self) {
        if self.active {
            info!("åœæ­¢æ§åˆ¶å™¨");
            if let Some(controller) = &self.controller {
                match controller.lock() {
                    Ok(mut controller) => {
                        controller.stop();
                    },
                    Err(e) => {
                        error!("åœæ­¢æ§åˆ¶å™¨æ—¶è·å–é”å¤±è´¥: {}", e);
                    }
                }
            }
            
            self.controller = None;
            self.active = false;
            self.status_message = "å·²åœæ­¢".to_string();
            self.status_color = Color32::GRAY;
            self.tray_tooltip = "æ¸¸æˆæ‰‹æŸ„é¼ æ ‡æ§åˆ¶å™¨ - å·²åœæ­¢".to_string();
        }
    }
    
    /// ä¿å­˜å½“å‰é…ç½®
    fn save_config(&self) {
        if let Err(e) = self.config.save() {
            error!("ä¿å­˜é…ç½®å¤±è´¥: {}", e);
        }
        
        // å¦‚æœæ§åˆ¶å™¨æ­£åœ¨è¿è¡Œï¼Œæ›´æ–°é…ç½®
        if let Some(controller) = &self.controller {
            match controller.lock() {
                Ok(mut controller) => {
                    controller.update_config(self.config.clone());
                    info!("å·²æ›´æ–°æ§åˆ¶å™¨é…ç½®");
                },
                Err(e) => {
                    error!("æ›´æ–°æ§åˆ¶å™¨é…ç½®æ—¶è·å–é”å¤±è´¥: {}", e);
                }
            }
        }
    }
    
    /// æ›´æ–°æ§åˆ¶å™¨çŠ¶æ€
    fn update_controller(&mut self) {
        // å¤„ç†æ‰‹æŸ„é€‰æ‹©å˜æ›´
        if let Some(index) = self.selected_gamepad_changed.take() {
            if self.active {
                info!("æ‰‹æŸ„é€‰æ‹©å·²å˜æ›´ï¼Œåœæ­¢å½“å‰æ§åˆ¶å™¨");
                self.stop_controller();
            }
            
            if let Some((id, name)) = self.available_gamepads.get(index) {
                self.selected_gamepad_index = index;
                info!("å·²é€‰æ‹©æ–°æ‰‹æŸ„: {} (ID: {:?})", name, id);
                self.gamepad_name = name.clone();
                
                // å½“æœ‰æ‰‹æŸ„é€‰æ‹©æ›´æ”¹ä¸”æœªå¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨å°è¯•å¯åŠ¨
                if !self.active && !self.available_gamepads.is_empty() {
                    info!("æ£€æµ‹åˆ°æ‰‹æŸ„é€‰æ‹©å˜æ›´ï¼Œå°è¯•è‡ªåŠ¨è¿æ¥åˆ°: {}", name);
                    self.start_selected_controller();
                }
            } else {
                warn!("æ— æ³•è·å–ç´¢å¼• {} å¤„çš„æ‰‹æŸ„ä¿¡æ¯", index);
            }
        }

        // æ·»åŠ å‘¨æœŸæ€§çŠ¶æ€æ£€æŸ¥
        let now = Instant::now();
        let check_interval = Duration::from_secs(5);
        let retry_interval = Duration::from_secs(if self.connection_retry_count > 3 { 15 } else { 5 });
        
        static mut LAST_CHECK: Option<Instant> = None;
        let should_check = unsafe {
            if let Some(last) = LAST_CHECK {
                if now.duration_since(last) >= check_interval {
                    LAST_CHECK = Some(now);
                    true
                } else {
                    false
                }
            } else {
                LAST_CHECK = Some(now);
                true
            }
        };

        if should_check {
            // ä½¿ç”¨ä¸€ä¸ªå¸ƒå°”å€¼æ¥è·Ÿè¸ªæ˜¯å¦éœ€è¦é‡æ–°å¯åŠ¨æ§åˆ¶å™¨ï¼Œè€Œä¸æ˜¯åœ¨åŒä¸€ä½œç”¨åŸŸå†…ä¿®æ”¹controller
            let mut need_restart = false;
            
            // å®šæœŸæ£€æŸ¥æ§åˆ¶å™¨çŠ¶æ€
            if let Some(controller) = &self.controller {
                match controller.lock() {
                    Ok(controller) => {
                        // æ£€æŸ¥æ§åˆ¶å™¨çŠ¶æ€
                        if controller.is_running() && controller.is_connected() {
                            self.status_message = "å·²è¿æ¥ï¼Œæ§åˆ¶å™¨è¿è¡Œä¸­".to_string();
                            self.status_color = Color32::GREEN;
                            // åªåœ¨çŠ¶æ€å˜åŒ–æ—¶è®°å½•æ—¥å¿—
                            if self.status_color != Color32::GREEN {
                                info!("æ§åˆ¶å™¨çŠ¶æ€æ£€æŸ¥ï¼šæ­£å¸¸è¿è¡Œä¸­");
                            }
                        } else if controller.is_running() && !controller.is_connected() {
                            info!("æ§åˆ¶å™¨è¿è¡Œä¸­ä½†æ‰‹æŸ„å·²æ–­å¼€è¿æ¥ï¼Œå°è¯•é‡æ–°è¿æ¥");
                            self.status_message = "æ‰‹æŸ„å·²æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥".to_string();
                            self.status_color = Color32::YELLOW;
                            
                            // ç”±äºæ§åˆ¶å™¨å·²æ–­å¼€è¿æ¥ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°å¯åŠ¨å®ƒ
                            need_restart = true;
                            info!("å‡†å¤‡é‡æ–°å¯åŠ¨æ§åˆ¶å™¨ä»¥å°è¯•æ¢å¤è¿æ¥");
                        } else {
                            info!("æ§åˆ¶å™¨å·²åœæ­¢è¿è¡Œï¼Œéœ€è¦é‡æ–°å¯åŠ¨");
                            self.status_message = "æ§åˆ¶å™¨å·²åœæ­¢ï¼Œå°è¯•é‡æ–°å¯åŠ¨".to_string();
                            self.status_color = Color32::YELLOW;
                            need_restart = true;
                        }
                    },
                    Err(e) => {
                        error!("æ— æ³•è·å–æ§åˆ¶å™¨é”: {}", e);
                        self.status_message = "æ§åˆ¶å™¨çŠ¶æ€å¼‚å¸¸".to_string();
                        self.status_color = Color32::RED;
                        need_restart = true;
                    }
                }
            } else if !self.active && !self.available_gamepads.is_empty() {
                // å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„æ§åˆ¶å™¨ä½†æœ‰å¯ç”¨çš„æ‰‹æŸ„ï¼Œå°è¯•è‡ªåŠ¨è¿æ¥
                let should_retry = now.duration_since(self.last_connection_attempt) >= retry_interval;
                
                if should_retry {
                    info!("å°è¯•è‡ªåŠ¨è¿æ¥å¯ç”¨çš„æ‰‹æŸ„ (é‡è¯•æ¬¡æ•°: {})", self.connection_retry_count);
                    need_restart = true;
                }
            }

            // åœ¨æ£€æŸ¥å®Œæˆåå¤„ç†é‡æ–°å¯åŠ¨é€»è¾‘
            if need_restart {
                self.active = false;
                self.controller = None;
                
                // å¦‚æœæ‰‹æŸ„ä»ç„¶å­˜åœ¨ï¼Œå°è¯•é‡æ–°å¯åŠ¨æ§åˆ¶å™¨
                if !self.available_gamepads.is_empty() {
                    self.start_selected_controller();
                }
            }
        }
    }
    
    /// æ‰«æå¹¶æ›´æ–°å¯ç”¨çš„æ‰‹æŸ„åˆ—è¡¨
    fn scan_gamepads(&mut self) {
        // æ¯500æ¯«ç§’æ‰«æä¸€æ¬¡
        const SCAN_INTERVAL: Duration = Duration::from_millis(500);
        
        if self.last_scan_time.elapsed() >= SCAN_INTERVAL {
            self.last_scan_time = Instant::now();
            
            // å°è¯•åˆå§‹åŒ–Gilrs
            if let Ok(gilrs) = Gilrs::new() {
                let mut new_gamepads = Vec::new();
                let mut current_id_exists = false;
                let mut found_new_gamepad = false;
                
                // è·å–å½“å‰å·²è¿æ¥çš„æ‰‹æŸ„
                for (id, gamepad) in gilrs.gamepads() {
                    let name = gamepad.name().to_string();
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°å‘ç°çš„æ‰‹æŸ„
                    let is_new = !self.available_gamepads.iter().any(|(existing_id, existing_name)| {
                        *existing_id == id && existing_name == &name
                    });
                    
                    if is_new {
                        info!("å‘ç°æ–°çš„æ‰‹æŸ„: {} (id: {:?})", name, id);
                        found_new_gamepad = true;
                    }
                    
                    new_gamepads.push((id, name.clone()));
                    
                    // æ£€æŸ¥å½“å‰é€‰æ‹©çš„æ¸¸æˆæ‰‹æŸ„æ˜¯å¦å­˜åœ¨
                    if self.selected_gamepad_index < self.available_gamepads.len() {
                        if let Some((selected_id, _)) = self.available_gamepads.get(self.selected_gamepad_index) {
                            if *selected_id == id {
                                current_id_exists = true;
                                
                                // å¦‚æœæ§åˆ¶å™¨ä¸åœ¨è¿è¡ŒçŠ¶æ€ä½†æ‰‹æŸ„å·²è¿æ¥ï¼Œå°è¯•è‡ªåŠ¨é‡è¿
                                if !self.active && self.gamepad_name == name {
                                    info!("æ£€æµ‹åˆ°ä¹‹å‰é€‰æ‹©çš„æ‰‹æŸ„å·²é‡æ–°è¿æ¥ï¼Œå°è¯•è‡ªåŠ¨æ¢å¤è¿æ¥");
                                    // å»¶è¿Ÿæ‰§è¡Œé‡è¿æ“ä½œï¼Œé¿å…UIçº¿ç¨‹é˜»å¡
                                    self.selected_gamepad_changed = Some(self.selected_gamepad_index);
                                }
                            }
                        }
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ‰‹æŸ„è¢«ç§»é™¤
                let gamepad_removed = self.available_gamepads.len() > new_gamepads.len();
                
                // å¦‚æœå½“å‰æ‰‹æŸ„ä¸å­˜åœ¨ä½†ç•Œé¢æ˜¾ç¤ºä»ç„¶æ´»è·ƒï¼Œåœæ­¢æ§åˆ¶å™¨
                if !current_id_exists && self.active {
                    info!("æ£€æµ‹åˆ°å½“å‰è¿æ¥çš„æ‰‹æŸ„å·²æ–­å¼€");
                    self.stop_controller();
                    self.status_message = "æ‰‹æŸ„å·²æ–­å¼€è¿æ¥".to_string();
                    self.status_color = Color32::RED;
                }
                
                // æ›´æ–°å¯ç”¨çš„æ‰‹æŸ„åˆ—è¡¨
                if gamepad_removed || found_new_gamepad || new_gamepads.len() != self.available_gamepads.len() {
                    info!("æ›´æ–°å¯ç”¨çš„æ‰‹æŸ„åˆ—è¡¨: ä» {} ä¸ªæ‰‹æŸ„åˆ° {} ä¸ªæ‰‹æŸ„", 
                         self.available_gamepads.len(), new_gamepads.len());
                    self.available_gamepads = new_gamepads;
                    
                    // å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„æ§åˆ¶å™¨ä½†æœ‰å¯ç”¨çš„æ‰‹æŸ„ï¼Œå°è¯•è‡ªåŠ¨è¿æ¥ç¬¬ä¸€ä¸ª
                    if !self.active && !self.available_gamepads.is_empty() && self.connection_retry_count < 3 {
                        if self.last_connection_attempt.elapsed() > Duration::from_secs(3) {
                            info!("å‘ç°å¯ç”¨æ‰‹æŸ„ï¼Œå°è¯•è‡ªåŠ¨è¿æ¥");
                            self.selected_gamepad_index = 0;
                            self.selected_gamepad_changed = Some(0);
                        }
                    }
                }
            }
        }
    }
    
    /// è·å–å½“å‰é€‰ä¸­çš„æ‰‹æŸ„ï¼ˆå¦‚æœæœ‰ï¼‰
    fn get_selected_gamepad(&self) -> Option<(gilrs::GamepadId, String)> {
        self.available_gamepads.get(self.selected_gamepad_index).cloned()
    }
    
    /// å¯åŠ¨é€‰ä¸­çš„æ‰‹æŸ„æ§åˆ¶å™¨
    pub fn start_selected_controller(&mut self) {
        // è·å–å½“å‰é€‰ä¸­çš„æ‰‹æŸ„
        if let Some(gamepad) = self.get_selected_gamepad() {
            info!("æ­£åœ¨å°è¯•è¿æ¥æ‰‹æŸ„: {} (id: {:?})", gamepad.1, gamepad.0);
            
            // å°è¯•åˆå§‹åŒ–Gilrs
            match Gilrs::new() {
                Ok(gilrs) => {
                    // æ£€æŸ¥æ‰‹æŸ„æ˜¯å¦è¿˜å­˜åœ¨
                    if gilrs.gamepad(gamepad.0).is_connected() {
                        info!("æ‰‹æŸ„å·²è¿æ¥ï¼Œå¼€å§‹åˆå§‹åŒ–æ§åˆ¶å™¨");
                        
                        // åˆ›å»ºæ§åˆ¶å™¨å®ä¾‹å¹¶æ£€æŸ¥æ˜¯å¦æˆåŠŸ
                        let controller = GamepadController::new(
                            gilrs,
                            gamepad.0,
                            self.config.clone(),
                        );
                        
                        // æ£€æŸ¥æ§åˆ¶å™¨æ˜¯å¦æ­£å¸¸åˆå§‹åŒ–å¹¶è¿è¡Œ
                        if controller.is_running() {
                            // ä¿å­˜æ§åˆ¶å™¨å¼•ç”¨
                            self.controller = Some(Arc::new(Mutex::new(controller)));
                            self.gamepad_name = gamepad.1.clone();
                            self.status_message = "å·²è¿æ¥ï¼Œæ§åˆ¶å™¨è¿è¡Œä¸­".to_string();
                            self.status_color = Color32::GREEN;
                            self.active = true;
                            self.tray_tooltip = format!("æ¸¸æˆæ‰‹æŸ„é¼ æ ‡æ§åˆ¶å™¨ - {}", self.gamepad_name);
                            self.connection_retry_count = 0; // é‡ç½®é‡è¯•è®¡æ•°
                            info!("æ‰‹æŸ„æ§åˆ¶å™¨å¯åŠ¨æˆåŠŸ");
                        } else {
                            self.status_message = "æ§åˆ¶å™¨åˆå§‹åŒ–å¤±è´¥ï¼Œæœªèƒ½å¯åŠ¨".to_string();
                            self.status_color = Color32::RED;
                            self.active = false;
                            info!("æ§åˆ¶å™¨åˆå§‹åŒ–æˆåŠŸä½†æœªèƒ½å¯åŠ¨");
                        }
                    } else {
                        self.status_message = format!("æ‰‹æŸ„å·²æ–­å¼€è¿æ¥: {}", gamepad.1);
                        self.status_color = Color32::RED;
                        self.active = false;
                        info!("æ‰‹æŸ„å·²æ–­å¼€è¿æ¥: {}", gamepad.1);
                    }
                },
                Err(err) => {
                    self.status_message = format!("æ— æ³•åˆå§‹åŒ–æ‰‹æŸ„ç³»ç»Ÿ: {}", err);
                    self.status_color = Color32::RED;
                    self.active = false;
                    error!("æ— æ³•åˆå§‹åŒ–æ‰‹æŸ„ç³»ç»Ÿ: {}", err);
                }
            }
        } else {
            self.status_message = "æœªé€‰æ‹©æ‰‹æŸ„".to_string();
            self.status_color = Color32::RED;
            info!("æœªé€‰æ‹©æ‰‹æŸ„ï¼Œæ— æ³•å¯åŠ¨æ§åˆ¶å™¨");
        }
        
        // æ›´æ–°æœ€åè¿æ¥å°è¯•æ—¶é—´
        self.last_connection_attempt = Instant::now();
    }
    
    /// åˆ·æ–°å¯ç”¨çš„æ‰‹æŸ„åˆ—è¡¨
    pub fn refresh_gamepads(&mut self) {
        info!("æ‰‹åŠ¨åˆ·æ–°å¯ç”¨çš„æ‰‹æŸ„åˆ—è¡¨");
        
        // å°è¯•åˆå§‹åŒ–Gilrs
        if let Ok(gilrs) = Gilrs::new() {
            let mut new_gamepads = Vec::new();
            
            // è·å–å½“å‰å·²è¿æ¥çš„æ‰‹æŸ„
            for (id, gamepad) in gilrs.gamepads() {
                let name = gamepad.name().to_string();
                new_gamepads.push((id, name));
            }
            
            // æ›´æ–°å¯ç”¨çš„æ‰‹æŸ„åˆ—è¡¨
            self.available_gamepads = new_gamepads;
            info!("å‘ç° {} ä¸ªå¯ç”¨æ‰‹æŸ„", self.available_gamepads.len());
        } else {
            error!("åˆ·æ–°æ‰‹æŸ„åˆ—è¡¨æ—¶æ— æ³•åˆå§‹åŒ–Gilrs");
        }
        
        // é‡ç½®è¿æ¥å°è¯•è®¡æ—¶
        self.last_connection_attempt = Instant::now().checked_sub(Duration::from_secs(3)).unwrap_or(Instant::now());
    }
}

/// è®¾ç½®UIçš„è‡ªå®šä¹‰å­—ä½“
fn setup_custom_fonts(ctx: &egui::Context) {
    // åˆ›å»ºé»˜è®¤å­—ä½“å®šä¹‰
    let mut fonts = egui::FontDefinitions::default();
    
    info!("åŠ è½½å†…åµŒä¸­æ–‡å­—ä½“...");
    
    // æ·»åŠ æˆ‘ä»¬çš„ä¸­æ–‡å­—ä½“
    fonts.font_data.insert(
        "source_han_sans".to_owned(),
        FontData::from_static(embedded_font::get_embedded_font_data())
    );
    
    // å°†ä¸­æ–‡å­—ä½“æ·»åŠ åˆ°æ¯”ä¾‹å­—ä½“æ—ï¼ˆä¸€èˆ¬UIæ–‡æœ¬ï¼‰çš„æœ€å‰é¢
    // è¿™æ ·ä¸­æ–‡å­—ç¬¦ä¼šä¼˜å…ˆä½¿ç”¨è¿™ä¸ªå­—ä½“
    fonts.families.entry(FontFamily::Proportional)
        .or_default()
        .insert(0, "source_han_sans".to_owned());
        
    // ä¹Ÿæ·»åŠ åˆ°ç­‰å®½å­—ä½“æ—
    fonts.families.entry(FontFamily::Monospace)
        .or_default()
        .insert(0, "source_han_sans".to_owned());
    
    // é’ˆå¯¹æ‰€æœ‰å­—ä½“æ•°æ®è¿›è¡Œè°ƒæ•´
    for (_, font_data) in fonts.font_data.iter_mut() {
        // å¢åŠ å­—ä½“ç¼©æ”¾æ¯”ä¾‹
        font_data.tweak.scale = 1.2;
    }
    
    info!("æˆåŠŸåŠ è½½å†…åµŒä¸­æ–‡å­—ä½“");
    
    // åº”ç”¨å­—ä½“é…ç½®
    ctx.set_fonts(fonts);
    
    // æé«˜UIå¯è¯»æ€§å’Œè§†è§‰æ•ˆæœ
    let mut style = (*ctx.style()).clone();
    
    // å¢åŠ UIå…ƒç´ é—´è·ä»¥æé«˜å¯è¯»æ€§
    style.spacing.item_spacing = egui::vec2(8.0, 6.0);
    style.spacing.button_padding = egui::vec2(8.0, 4.0);
    style.spacing.window_margin = egui::Margin::same(10.0);
    style.spacing.slider_width = 200.0;
    
    // åœ†è§’æŒ‰é’®å’Œçª—å£
    style.visuals.window_rounding = egui::Rounding::same(6.0);
    style.visuals.button_frame = true;
    style.visuals.widgets.active.rounding = egui::Rounding::same(4.0);
    style.visuals.widgets.inactive.rounding = egui::Rounding::same(4.0);
    style.visuals.widgets.hovered.rounding = egui::Rounding::same(4.0);
    
    // è°ƒæ•´é¢œè‰²
    style.visuals.hyperlink_color = egui::Color32::from_rgb(0, 155, 255);
    
    // å¢åŠ é»˜è®¤å­—ä½“å¤§å°
    for (text_style, font_id) in style.text_styles.iter_mut() {
        match text_style {
            egui::TextStyle::Heading => font_id.size = 22.0,
            egui::TextStyle::Body => font_id.size = 16.0,
            egui::TextStyle::Monospace => font_id.size = 14.0,
            egui::TextStyle::Button => font_id.size = 16.0,
            egui::TextStyle::Small => font_id.size = 12.0,
            _ => font_id.size *= 1.2,
        }
    }
    
    ctx.set_style(style);
    info!("å·²é…ç½®UIå­—ä½“å’Œæ ·å¼ä»¥æé«˜å¯è¯»æ€§å’Œç¾è§‚åº¦");
}

impl eframe::App for GamepadMouseApp {
    fn update(&mut self, ctx: &egui::Context, _frame: &mut eframe::Frame) {
        // æ›´æ–°æ§åˆ¶å™¨çŠ¶æ€
        self.update_controller();
        
        // æ‰«æå¹¶æ›´æ–°å¯ç”¨çš„æ‰‹æŸ„åˆ—è¡¨
        self.scan_gamepads();
        
        // é¡¶éƒ¨èœå•æ 
        egui::TopBottomPanel::top("top_panel").show(ctx, |ui| {
            egui::menu::bar(ui, |ui| {
                ui.menu_button("æ–‡ä»¶", |ui| {
                    if ui.button("ä¿å­˜é…ç½®").clicked() {
                        self.save_config();
                        ui.close_menu();
                    }
                    if ui.button("é€€å‡º").clicked() {
                        ctx.send_viewport_cmd(egui::ViewportCommand::Close);
                    }
                });
                
                ui.menu_button("å¸®åŠ©", |ui| {
                    if ui.button("ä½¿ç”¨è¯´æ˜").clicked() {
                        self.show_help = true;
                        ui.close_menu();
                    }
                    if ui.button("å…³äº").clicked() {
                        // æ˜¾ç¤ºå…³äºå¯¹è¯æ¡†
                        ui.close_menu();
                    }
                });
            });
        });
        
        // ä¸»å†…å®¹åŒºåŸŸ
        egui::CentralPanel::default().show(ctx, |ui| {
            ui.vertical_centered(|ui| {
                ui.heading("æ¸¸æˆæ‰‹æŸ„é¼ æ ‡æ§åˆ¶å™¨");
            });
            ui.add_space(4.0);

            // çŠ¶æ€é¢æ¿
            ui.horizontal(|ui| {
                ui.strong("çŠ¶æ€: ");
                ui.colored_label(self.status_color, &self.status_message);
                
                ui.with_layout(Layout::right_to_left(Align::Center), |ui| {
                    if self.active {
                        let stop_btn = ui.add(egui::Button::new("â¹ åœæ­¢").min_size(egui::vec2(80.0, 28.0)));
                        if stop_btn.clicked() {
                            self.stop_controller();
                        }
                    } else {
                        let start_btn = ui.add(egui::Button::new("â–¶ å¯åŠ¨").min_size(egui::vec2(80.0, 28.0)));
                        if start_btn.clicked() {
                            self.start_selected_controller();
                        }
                        
                        let refresh_btn = ui.add(egui::Button::new("ğŸ”„ åˆ·æ–°").min_size(egui::vec2(80.0, 28.0)));
                        if refresh_btn.clicked() {
                            self.refresh_gamepads();
                        }
                    }
                });
            });
            
            // æ‰‹æŸ„é€‰æ‹©
            ui.horizontal(|ui| {
                ui.strong("é€‰æ‹©æ‰‹æŸ„: ");
                let mut current_gamepad = self.gamepad_name.clone();
                let mut selected_index = None;
                
                egui::ComboBox::from_id_source("gamepad_selection")
                    .width(280.0)
                    .selected_text(&current_gamepad)
                    .show_ui(ui, |ui| {
                        // æ˜¾ç¤ºå¯ç”¨çš„æ‰‹æŸ„åˆ—è¡¨
                        for (i, (_, name)) in self.available_gamepads.iter().enumerate() {
                            if ui.selectable_value(&mut current_gamepad, name.clone(), name).clicked() {
                                // å¦‚æœé€‰æ‹©äº†ä¸åŒçš„æ‰‹æŸ„ï¼Œè®°å½•é€‰æ‹©
                                if self.selected_gamepad_index != i {
                                    selected_index = Some((i, name.clone()));
                                }
                            }
                        }
                    });
                    
                // åœ¨UIé—­åŒ…å¤–å¤„ç†æ‰‹æŸ„é€‰æ‹©å˜æ›´
                if let Some((i, name)) = selected_index {
                    // å¦‚æœå½“å‰æœ‰æ§åˆ¶å™¨åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢
                    if self.active {
                        self.stop_controller();
                    }
                    self.selected_gamepad_index = i;
                    self.gamepad_name = name;
                    // æ ‡è®°é€‰æ‹©å·²æ›´æ”¹ï¼Œä¸‹ä¸€å¸§ä¼šå¤„ç†è‡ªåŠ¨è¿æ¥
                    self.selected_gamepad_changed = Some(i);
                }
            });
            ui.separator();
            
            // ä½¿ç”¨æ»šåŠ¨åŒºåŸŸåŒ…è£…æ‰€æœ‰é…ç½®é€‰é¡¹
            egui::ScrollArea::vertical()
                .auto_shrink([false, false])
                .show(ui, |ui| {
                    // é…ç½®é€‰é¡¹
                    egui::CollapsingHeader::new("ğŸ–±ï¸ é¼ æ ‡çµæ•åº¦è®¾ç½®")
                        .default_open(true)
                        .show(ui, |ui| {
                            ui.add_space(4.0);
                            
                            // ä½¿ç”¨ç½‘æ ¼å¸ƒå±€ä½¿ç•Œé¢æ›´æ•´æ´
                            egui::Grid::new("settings_grid")
                                .num_columns(3)
                                .spacing([20.0, 10.0])
                                .striped(true)
                                .show(ui, |ui| {
                                    ui.label("é¼ æ ‡ç§»åŠ¨çµæ•åº¦:");
                                    ui.add(Slider::new(&mut self.config.mouse_sensitivity, 1.0..=30.0).text(""));
                                    if ui.button("é‡ç½®").clicked() {
                                        self.config.mouse_sensitivity = Config::default().mouse_sensitivity;
                                    }
                                    ui.end_row();
                                    
                                    ui.label("æ‘‡æ†æ­»åŒº:");
                                    ui.add(Slider::new(&mut self.config.dead_zone, 0.0..=0.5).text(""));
                                    if ui.button("é‡ç½®").clicked() {
                                        self.config.dead_zone = Config::default().dead_zone;
                                    }
                                    ui.end_row();
                                    
                                    ui.label("æ»šè½®çµæ•åº¦:");
                                    ui.add(Slider::new(&mut self.config.scroll_sensitivity, 1.0..=20.0).text(""));
                                    if ui.button("é‡ç½®").clicked() {
                                        self.config.scroll_sensitivity = Config::default().scroll_sensitivity;
                                    }
                                    ui.end_row();
                                    
                                    ui.label("åŠ é€Ÿæ›²çº¿:");
                                    ui.add(Slider::new(&mut self.config.mouse_acceleration, 1.0..=3.0).text(""));
                                    if ui.button("é‡ç½®").clicked() {
                                        self.config.mouse_acceleration = Config::default().mouse_acceleration;
                                    }
                                    ui.end_row();
                                });
                                
                            ui.add_space(8.0);
                            
                            // ä½¿ç”¨æ¨ªå‘å¸ƒå±€æ”¾ç½®å¤é€‰æ¡†ä½¿ç•Œé¢æ›´ç´§å‡‘
                            ui.horizontal(|ui| {
                                ui.checkbox(&mut self.config.use_left_stick_for_mouse, "ä½¿ç”¨å·¦æ‘‡æ†æ§åˆ¶é¼ æ ‡");
                                ui.add_space(20.0);
                                ui.checkbox(&mut self.config.invert_x_axis, "åè½¬Xè½´");
                                ui.add_space(20.0);
                                ui.checkbox(&mut self.config.invert_y_axis, "åè½¬Yè½´");
                            });
                        });
                    
                    ui.add_space(8.0);
                    
                    egui::CollapsingHeader::new("ğŸ® æŒ‰é”®æ˜ å°„")
                        .default_open(true)
                        .show(ui, |ui| {
                            ui.add_space(4.0);
                            
                            // ä½¿ç”¨ç½‘æ ¼å¸ƒå±€ä½¿æŒ‰é”®æ˜ å°„æ›´æ•´æ´
                            egui::Grid::new("buttons_grid")
                                .num_columns(2)
                                .spacing([20.0, 10.0])
                                .striped(true)
                                .show(ui, |ui| {
                                    // é¼ æ ‡æŒ‰é’®æ˜ å°„
                                    ui.strong("é¼ æ ‡æŒ‰é’®");
                                    ui.strong("æ‰‹æŸ„æŒ‰é’®");
                                    ui.end_row();
                                    
                                    ui.label("å·¦é”®ç‚¹å‡»:");
                                    egui::ComboBox::from_id_source("left_click_button")
                                        .width(180.0)
                                        .selected_text(button_display_name(&self.config.left_click_button))
                                        .show_ui(ui, |ui| {
                                            for (name, display) in get_button_options() {
                                                ui.selectable_value(&mut self.config.left_click_button, name, display);
                                            }
                                        });
                                    ui.end_row();
                                    
                                    ui.label("å³é”®ç‚¹å‡»:");
                                    egui::ComboBox::from_id_source("right_click_button")
                                        .width(180.0)
                                        .selected_text(button_display_name(&self.config.right_click_button))
                                        .show_ui(ui, |ui| {
                                            for (name, display) in get_button_options() {
                                                ui.selectable_value(&mut self.config.right_click_button, name, display);
                                            }
                                        });
                                    ui.end_row();
                                    
                                    ui.label("ä¸­é”®ç‚¹å‡»:");
                                    egui::ComboBox::from_id_source("middle_click_button")
                                        .width(180.0)
                                        .selected_text(button_display_name(&self.config.middle_click_button))
                                        .show_ui(ui, |ui| {
                                            for (name, display) in get_button_options() {
                                                ui.selectable_value(&mut self.config.middle_click_button, name, display);
                                            }
                                        });
                                    ui.end_row();
                                    
                                    ui.label("åŒå‡»æŒ‰é’®:");
                                    egui::ComboBox::from_id_source("double_click_button")
                                        .width(180.0)
                                        .selected_text(button_display_name(&self.config.double_click_button))
                                        .show_ui(ui, |ui| {
                                            for (name, display) in get_button_options() {
                                                ui.selectable_value(&mut self.config.double_click_button, name, display);
                                            }
                                        });
                                    ui.end_row();
                                    
                                    // ç‰¹æ®Šæ¨¡å¼æŒ‰é’®
                                    ui.strong("ç‰¹æ®Šæ¨¡å¼");
                                    ui.strong("è§¦å‘æŒ‰é’®");
                                    ui.end_row();
                                    
                                    ui.label("ç²¾ç¡®æ¨¡å¼æŒ‰é’®:");
                                    egui::ComboBox::from_id_source("precision_mode_button")
                                        .width(180.0)
                                        .selected_text(button_display_name(&self.config.precision_mode_button))
                                        .show_ui(ui, |ui| {
                                            ui.selectable_value(&mut self.config.precision_mode_button, "LeftTrigger".to_string(), "å·¦æ‰³æœº");
                                            ui.selectable_value(&mut self.config.precision_mode_button, "RightTrigger".to_string(), "å³æ‰³æœº");
                                            ui.selectable_value(&mut self.config.precision_mode_button, "LeftThumb".to_string(), "å·¦æ‘‡æ†æŒ‰ä¸‹");
                                            ui.selectable_value(&mut self.config.precision_mode_button, "RightThumb".to_string(), "å³æ‘‡æ†æŒ‰ä¸‹");
                                        });
                                    ui.end_row();
                                    
                                    ui.label("åŠ é€Ÿæ¨¡å¼æŒ‰é’®:");
                                    egui::ComboBox::from_id_source("turbo_mode_button")
                                        .width(180.0)
                                        .selected_text(button_display_name(&self.config.turbo_mode_button))
                                        .show_ui(ui, |ui| {
                                            ui.selectable_value(&mut self.config.turbo_mode_button, "LeftTrigger".to_string(), "å·¦æ‰³æœº");
                                            ui.selectable_value(&mut self.config.turbo_mode_button, "RightTrigger".to_string(), "å³æ‰³æœº");
                                            ui.selectable_value(&mut self.config.turbo_mode_button, "LeftThumb".to_string(), "å·¦æ‘‡æ†æŒ‰ä¸‹");
                                            ui.selectable_value(&mut self.config.turbo_mode_button, "RightThumb".to_string(), "å³æ‘‡æ†æŒ‰ä¸‹");
                                        });
                                    ui.end_row();
                                });
                        });
                });
                
            ui.separator();
            // åº•éƒ¨çŠ¶æ€æ 
            ui.horizontal(|ui| {
                ui.label(format!("è¿æ¥è®¾å¤‡: {}", if self.available_gamepads.is_empty() { "æ— " } else { &format!("{} ä¸ª", self.available_gamepads.len()) }));
                
                ui.with_layout(Layout::right_to_left(Align::Center), |ui| {
                    if ui.link("æŸ¥çœ‹å¸®åŠ©").clicked() {
                        self.show_help = true;
                    }
                });
            });
            
            // å¸®åŠ©å¯¹è¯æ¡†
            if self.show_help {
                egui::Window::new("ä½¿ç”¨è¯´æ˜")
                    .collapsible(false)
                    .resizable(true)
                    .default_width(400.0)
                    .show(ctx, |ui| {
                        ui.heading("æ¸¸æˆæ‰‹æŸ„é¼ æ ‡æ§åˆ¶å™¨ä½¿ç”¨è¯´æ˜");
                        ui.separator();
                        
                        egui::ScrollArea::vertical().show(ui, |ui| {
                            ui.heading("åŸºæœ¬æ§åˆ¶");
                            ui.label("â€¢ ä½¿ç”¨å³æ‘‡æ†ç§»åŠ¨é¼ æ ‡å…‰æ ‡");
                            ui.label("â€¢ ä½¿ç”¨å·¦æ‘‡æ†æ§åˆ¶æ»šè½®");
                            ui.label("â€¢ AæŒ‰é’® (å—/ä¸‹æŒ‰é’®) æ‰§è¡Œé¼ æ ‡å·¦é”®ç‚¹å‡»");
                            ui.label("â€¢ BæŒ‰é’® (ä¸œ/å³æŒ‰é’®) æ‰§è¡Œé¼ æ ‡å³é”®ç‚¹å‡»");
                            
                            ui.add_space(8.0);
                            ui.heading("é«˜çº§åŠŸèƒ½");
                            ui.label("â€¢ ç²¾ç¡®æ¨¡å¼ - æŒ‰ä½æŒ‰é’®é™ä½é¼ æ ‡é€Ÿåº¦ï¼Œç”¨äºç²¾ç¡®æ§åˆ¶");
                            ui.label("â€¢ åŠ é€Ÿæ¨¡å¼ - æŒ‰ä½æŒ‰é’®æé«˜é¼ æ ‡é€Ÿåº¦ï¼Œç”¨äºå¿«é€Ÿç§»åŠ¨");
                            ui.label("â€¢ åŒå‡»æŒ‰é’® - å¿«é€Ÿæ‰§è¡ŒåŒå‡»æ“ä½œ");
                            
                            ui.add_space(8.0);
                            ui.heading("æ•…éšœæ’é™¤");
                            ui.label("â€¢ å¦‚æœæ‰‹æŸ„æ— æ³•è¢«æ£€æµ‹åˆ°ï¼Œè¯·å°è¯•é‡æ–°æ’æ‹”");
                            ui.label("â€¢ å¦‚æœæ§åˆ¶ä¸ç²¾ç¡®ï¼Œè¯·å°è¯•è°ƒæ•´çµæ•åº¦å’Œæ­»åŒºè®¾ç½®");
                            ui.label("â€¢ ç¨‹åºæ”¯æŒçƒ­æ’æ‹”ï¼Œå¯ä»¥éšæ—¶æ’æ‹”æ‰‹æŸ„");
                            ui.label("â€¢ å¦‚æœé¼ æ ‡ç§»åŠ¨å¼‚å¸¸ï¼Œå°è¯•è°ƒæ•´æ­»åŒºæˆ–çµæ•åº¦å‚æ•°");
                            ui.label("â€¢ å¦‚æœæ— æ³•å¯åŠ¨ï¼Œè¯·æ£€æŸ¥æ‰‹æŸ„æ˜¯å¦è¢«å…¶ä»–ç¨‹åºå ç”¨");
                            
                            ui.add_space(8.0);
                            ui.heading("æç¤º");
                            ui.label("â€¢ å¯ä»¥éšæ—¶è°ƒæ•´è®¾ç½®ï¼Œæ›´æ”¹ä¼šç«‹å³ç”Ÿæ•ˆ");
                            ui.label("â€¢ ä½¿ç”¨ç²¾ç¡®æ¨¡å¼æ›´å®¹æ˜“è¿›è¡Œç²¾ç»†æ“ä½œ");
                            ui.label("â€¢ åº”ç”¨ç¨‹åºä¿å­˜æ‚¨çš„è®¾ç½®ä¾›ä¸‹æ¬¡ä½¿ç”¨");
                        });
                        
                        ui.separator();
                        ui.vertical_centered(|ui| {
                            if ui.button("å…³é—­").clicked() {
                                self.show_help = false;
                            }
                        });
                    });
            }
        });
    }
}
